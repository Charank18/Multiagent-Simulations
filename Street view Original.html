<!DOCTYPE html>
<html>
<head>
  <title>Agent Conversation Simulation</title>
  <style>
    /* Basic body reset */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    /* Return button styling */
    #return-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 2001;
      padding: 12px 24px;
      border-radius: 20px;
      border: none;
      background-color: #0fb100;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }

    #return-btn:hover {
      background-color: #019236;
    }

    /* Conversation View container */
    #conversation-view {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
    }

    /* Container that holds the 3D models (the agents) */
    #agent-3d-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: transparent;
      pointer-events: none;
    }

    /* Chat UI area inside the conversation view */
    #chat-container {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 40%;
      padding: 20px;
      border-radius: 12px;
      background-color: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 2001;
    }

    #chat-log {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 10px;
    }

    .chat-message {
      display: flex;
      flex-direction: column;
    }

    .chat-message.user {
      margin: 10px 0;
      align-items: flex-end;
    }

    .chat-message.agent1 {
      margin: 0 10px;
      align-items: flex-start;
    }
    .chat-message.agent2 {
      margin: 10px 0;
      align-items: flex-end;
    }

    .chat-bubble {
      max-width: 70%;
      border-radius: 20px;
      word-wrap: break-word;
      position: relative;
      backdrop-filter: blur(5px);
    }

    .chat-bubble.user {
      background-color: #0fb100;
      color: white;
      border-bottom-right-radius: 4px;
      margin: 4px 0;
      padding: 12px 16px;
    }

    .chat-bubble.agent1 {
      color:white;
      border-bottom-left-radius: 4px;
      background-color: rgb(75, 132, 255);
      padding: 16px 12px;
    }
     
    .chat-bubble.agent2 {
      color: white;
      border-bottom-right-radius: 4px;
      background-color: rgba(255, 63, 10, 0.85);
      margin: 0 4px;
      padding: 12px 16px;
    }

    .chat-sender {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.9);
      margin: 2px 8px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    #chat-input {
      width: 80%;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      margin-right: 10px;
      font-size: 14px;
      background-color: rgba(255, 255, 255, 0.15);
      color: white;
      backdrop-filter: blur(5px);
    }

    #chat-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    #chat-send, #start-interaction, #pause-interaction, #resume-interaction {
      padding: 12px 24px;
      border-radius: 20px;
      border: none;
      background-color: #0fb100;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
      margin: 5px;
    }

    #chat-send:hover, #start-interaction:hover, #pause-interaction:hover, #resume-interaction:hover {
      background-color: #019236;
    }

    .button-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
  
  <!-- Include Three.js and GLTFLoader for 3D agents -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>
  <!-- Conversation View -->
  <div id="conversation-view">
    <button id="return-btn" onclick="location.reload()">Restart Conversation</button>
    <!-- Container for 3D agents -->
    <div id="agent-3d-container"></div>
    <!-- Chat UI area -->
    <div id="chat-container">
      <div id="chat-log"></div>
      <div style="display: flex; align-items: center;">
        <input type="text" id="chat-input" placeholder="Type a message...">
        <button id="chat-send" onclick="sendMessage()">Send</button>
      </div>
      <div class="button-container">
        <button id="start-interaction" onclick="startAgentInteraction()">Start Agent Interaction</button>
        <button id="pause-interaction" onclick="pauseAgentInteraction()">Pause Interaction</button>
        <button id="resume-interaction" onclick="resumeAgentInteraction()" style="display:none;">Resume Interaction</button>
      </div>
    </div>
  </div>

  <script>
    // Global conversation variables
    let isConversationPaused = false;
    let conversationTimeout;
    let conversationHistory = [];
    
    // 3D scene variables
    let scene, camera, renderer;
    let agent1, agent2;
    let currentTalkingAgent = null;

    // Initialize the page
    window.onload = function() {
      init3DScene();
      setBackgroundImage();
    };

    function init3DScene() {
      const container = document.getElementById("agent-3d-container");
      
      // Create Three.js scene
      scene = new THREE.Scene();

      // Set up camera
      const width = container.clientWidth;
      const height = container.clientHeight;
      camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
      camera.position.set(0, 2, 5);

      // Set up renderer
      renderer = new THREE.WebGLRenderer({ alpha: true });
      renderer.setSize(width, height);
      container.appendChild(renderer.domElement);

      // Add lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 1);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(5, 5, 5);
      scene.add(directionalLight);

      // Load Agent1 model
      const loader = new THREE.GLTFLoader();
      loader.load('./models/agent1.glb', function(gltf) {
        agent1 = gltf.scene;
        agent1.position.set(-3, 0.5, 0);
        agent1.scale.set(0.625, 0.6875, 0.3125);
        agent1.rotation.set(0, 0.6, 0);
        scene.add(agent1);
        agent1.defaultRotation = agent1.rotation.y;
      }, undefined, function(error) {
        console.error('Error loading Agent1:', error);
      });

      // Load Agent2 model
      loader.load('./models/agent2.glb', function(gltf) {
        agent2 = gltf.scene;
        agent2.position.set(3, 3.0, 0);
        agent2.scale.set(0.625, 0.6875, 0.3125);
        agent2.rotation.set(0, -0.6, 0);
        scene.add(agent2);
        agent2.defaultRotation = agent2.rotation.y;
      }, undefined, function(error) {
        console.error('Error loading Agent2:', error);
      });

      // Handle window resize
      window.addEventListener('resize', onWindowResize, false);
      function onWindowResize() {
        const width = container.clientWidth;
        const height = container.clientHeight;
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height);
      }

      animateScene();
    }

    function animateScene() {
      requestAnimationFrame(animateScene);
      
      if (!isConversationPaused) {
        // Talking animation
        if (currentTalkingAgent === "Agent1" && agent1) {
          agent1.rotation.y = agent1.defaultRotation + Math.sin(Date.now() * 0.005) * 0.2;
          agent1.position.y = Math.sin(Date.now() * 0.003) * 0.15;
        } else if (agent1) {
          // Idle animation
          agent1.rotation.y = agent1.defaultRotation + Math.sin(Date.now() * 0.001) * 0.05;
          agent1.position.y = Math.sin(Date.now() * 0.001) * 0.05;
        }

        if (currentTalkingAgent === "Agent2" && agent2) {
          agent2.rotation.y = agent2.defaultRotation + Math.sin(Date.now() * 0.005) * 0.2;
          agent2.position.y = Math.sin(Date.now() * 0.003) * 0.15;
        } else if (agent2) {
          // Idle animation
          agent2.rotation.y = agent2.defaultRotation + Math.sin(Date.now() * 0.001) * 0.05;
          agent2.position.y = Math.sin(Date.now() * 0.001) * 0.05;
        }
      } else {
        // Still animation when paused
        if (agent1) {
          agent1.rotation.y = agent1.defaultRotation;
          agent1.position.y = 0;
        }
        if (agent2) {
          agent2.rotation.y = agent2.defaultRotation;
          agent2.position.y = 0;
        }
      }
      
      renderer.render(scene, camera);
    }

    function setBackgroundImage() {
      const lat = 40.7128;
      const lng = -74.0060;
      const streetViewUrl = `https://maps.googleapis.com/maps/api/streetview?size=1600x1200&location=${lat},${lng}&fov=80&pitch=0&heading=235&key=AIzaSyC_pStvBjzohEXBXJnGI5TjDACjaxuvA5E`;
      document.getElementById("conversation-view").style.backgroundImage = `url('${streetViewUrl}')`;
    }

    function sendMessage() {
      const userInput = document.getElementById("chat-input").value.trim();
      if (!userInput) return;
      document.getElementById("chat-input").value = "";
      addToChatLog("User", userInput);
      callGemini([ { role: "user", content: userInput } ])
        .then(response => {
          addToChatLog("Agent", response);
        })
        .catch(err => {
          console.error("LLM Error:", err);
          addToChatLog("Agent", "Sorry, something went wrong...");
        });
    }

    function addToChatLog(sender, text) {
      const chatLog = document.getElementById("chat-log");
      const messageDiv = document.createElement("div");
      messageDiv.className = `chat-message ${sender.toLowerCase()}`;
      
      const senderDiv = document.createElement("div");
      senderDiv.className = "chat-sender";
      senderDiv.textContent = sender;
      
      const bubbleDiv = document.createElement("div");
      bubbleDiv.className = `chat-bubble ${sender.toLowerCase()}`;
      bubbleDiv.textContent = text;
      
      messageDiv.appendChild(senderDiv);
      messageDiv.appendChild(bubbleDiv);
      chatLog.appendChild(messageDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function callGemini(messages) {
      const apiKey = "AIzaSyA0wkXKSlsuikUyYelw1lk9zWRs1f5-2f8";
      const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + apiKey;

      const conversationText = messages.map(msg => {
        if (msg.role === "system") {
          return `Instructions: ${msg.content}`;
        }
        return `${msg.role}: ${msg.content}`;
      }).join('\n');

      const prompt = {
        contents: [{
          parts: [{
            text: conversationText
          }]
        }]
      };

      return fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(prompt),
      })
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          if (data.candidates && data.candidates.length > 0 &&
              data.candidates[0].content && data.candidates[0].content.parts &&
              data.candidates[0].content.parts.length > 0) {
            return data.candidates[0].content.parts[0].text;
          }
          throw new Error("No valid response from API");
        });
    }

    function startAgentInteraction() {
      conversationHistory = [];
      
      conversationHistory.push({
        role: "system",
        content: "You are to simulate a conversation between Agent1 and Agent2. Agent1 is witty and friendly; Agent2 is serious and analytical. They discuss topics related to urban navigation, technology, and innovation."
      });
      
      conversationHistory.push({
        role: "user",
        content: "Hello, let's start our conversation."
      });

      document.getElementById("chat-log").innerHTML = '';
      addToChatLog("System", "Starting new conversation...");
      addToChatLog("User", "Hello, let's start our conversation.");

      simulateAgentConversation("Agent1");
    }

    function simulateAgentConversation(currentAgent) {
      if (isConversationPaused) return;
      
      currentTalkingAgent = currentAgent;
      
      const prompt = `${currentAgent} says:`;
      const messagesForAPI = [...conversationHistory, { role: "user", content: prompt }];

      callGemini(messagesForAPI)
        .then(response => {
          const agentMessage = `${currentAgent}: ${response}`;
          conversationHistory.push({ role: "assistant", content: agentMessage });
          addToChatLog(currentAgent, response);

          const nextAgent = currentAgent === "Agent1" ? "Agent2" : "Agent1";
          conversationTimeout = setTimeout(() => {
            simulateAgentConversation(nextAgent);
          }, 2000);
        })
        .catch(err => {
          console.error("Error:", err);
          addToChatLog("System", `Error: ${err.message}`);
          currentTalkingAgent = null;
        });
    }

    function pauseAgentInteraction() {
      isConversationPaused = true;
      currentTalkingAgent = null;
      clearTimeout(conversationTimeout);
      document.getElementById("pause-interaction").style.display = "none";
      document.getElementById("resume-interaction").style.display = "inline-block";
      addToChatLog("System", "Agent interaction paused.");
    }

    function resumeAgentInteraction() {
      isConversationPaused = false;
      document.getElementById("resume-interaction").style.display = "none";
      document.getElementById("pause-interaction").style.display = "inline-block";
      addToChatLog("System", "Agent interaction resumed.");
      
      let lastMsg = conversationHistory[conversationHistory.length - 1];
      let lastAgent = (lastMsg && lastMsg.content && lastMsg.content.includes("Agent1")) ? "Agent1" : "Agent2";
      const nextAgent = lastAgent === "Agent1" ? "Agent2" : "Agent1";
      simulateAgentConversation(nextAgent);
    }
  </script>
</body>
</html>